# 后端架构详解

> **目标**: 深入理解 PaperTok 后端的垂直切片架构和模块职责

---

## 1. 架构模式：Vertical Slice Architecture

PaperTok 后端采用**垂直切片架构**，按业务功能垂直划分代码，而非按技术层水平划分。

### 1.1 与传统分层架构对比

```
传统 Layered Architecture（水平分层）:
┌─────────────────────────────────────┐
│           Controllers               │
├─────────────────────────────────────┤
│  PaperService (所有逻辑混在一起)     │
├─────────────────────────────────────┤
│           Repositories              │
└─────────────────────────────────────┘

Vertical Slice Architecture（垂直切片）:
┌─────────────┐ ┌─────────────┐
│  PaperFeed  │ │ PaperSearch │
│   Feature   │ │   Feature   │
│     ↓       │ │     ↓       │
│   Repo      │ │   Repo      │
└─────────────┘ └─────────────┘
        ↓               ↓
┌─────────────────────────────────────┐
│     Shared Kernel (Core + Infra)    │
└─────────────────────────────────────┘
```

### 1.2 架构优势

| 优势 | 说明 |
|------|------|
| **高内聚** | 每个功能的代码集中在一个目录 |
| **松耦合** | Feature 之间通过接口隔离 |
| **独立测试** | 每个 Feature 可独立测试 |
| **渐进开发** | 新功能 = 新 Feature 目录 |
| **易于删除** | 废弃功能只需删除目录 |

---

## 2. 分层详解

### 2.1 API Layer (`internal/api/`)

**职责**：
- HTTP 请求路由
- 参数解析与校验
- 响应格式化
- 中间件（CORS、日志）

**关键文件**：
- `handlers/paper.go` - 论文相关接口
- `handlers/health.go` - 健康检查
- `middleware/cors.go` - CORS 中间件
- `middleware/logger.go` - 日志中间件

**示例**：
```go
func (h *PaperHandler) GetPapers(c *gin.Context) {
    // 1. 解析参数
    category := c.DefaultQuery("category", "cs.AI")
    
    // 2. 调用 Facade
    papers, err := h.facade.GetPaperFeed(ctx, category, limit, offset, sortBy)
    
    // 3. 返回响应
    c.JSON(http.StatusOK, APIResponse{...})
}
```

### 2.2 Facade Layer (`internal/facade/`)

**职责**：
- 统一业务入口
- 依赖组装与注入
- 协调多个 Feature

**设计原则**：
- API Layer 只与 Facade 交互
- Facade 管理所有 Feature 实例
- 提供简洁的公开方法

**示例**：
```go
type Facade struct {
    paperFeedSvc   paperfeed.Service
    paperSearchSvc papersearch.Service
}

func (f *Facade) GetPaperFeed(ctx context.Context, ...) ([]*Paper, error) {
    return f.paperFeedSvc.GetFeed(ctx, req)
}
```

### 2.3 Features Layer (`internal/features/`)

**职责**：
- 业务功能实现
- 每个 Feature 是独立的垂直切片

**当前 Features**：

| Feature | 职责 | 路径 |
|---------|------|------|
| `paperfeed` | 论文推荐流 | `features/paperfeed/` |
| `papersearch` | 论文搜索 | `features/papersearch/` |

**标准结构**：
```
features/paperfeed/
├── interface.go     # 对外接口
├── deps.go          # 依赖接口
├── service.go       # 实现
└── service_test.go  # 测试
```

### 2.4 Core Services (`internal/core/`)

**职责**：
- 共享业务能力
- 被多个 Feature 使用

**当前 Core Services**：

| Service | 职责 | 路径 |
|---------|------|------|
| `arxiv` | arXiv API 客户端 | `core/arxiv/` |

**标准结构**：
```
core/arxiv/
├── interface.go     # 对外接口
├── deps.go          # 依赖接口
├── types.go         # 数据类型
├── errors.go        # 错误定义
├── client.go        # 实现
└── client_test.go   # 测试
```

### 2.5 Repository Layer (`internal/repository/`)

**职责**：
- 数据访问抽象
- 隔离存储实现细节

**当前 Repositories**：

| Repository | 职责 | 存储 |
|------------|------|------|
| `paper` | 论文数据缓存 | 内存 |

### 2.6 Infrastructure Layer (`internal/infra/`)

**职责**：
- 基础设施能力
- 跨模块共享

**当前 Infrastructure**：

| 模块 | 职责 |
|------|------|
| `cache` | 内存缓存 |
| `httpclient` | HTTP 客户端 |

---

## 3. 依赖方向

```
API Layer
    ↓
Facade Layer
    ↓
Features ────→ Core Services
    ↓              ↓
Repository ←─────────┘
    ↓
Infrastructure
```

**规则**：
- ✅ Features 可依赖 Core、Repository、Infra
- ✅ Core 可依赖 Infra
- ❌ Features 之间不能相互依赖
- ❌ Core 不能依赖 Features
- ❌ 禁止循环依赖

---

## 4. 添加新功能指南

### 4.1 添加新 Feature

```bash
# 1. 创建目录
mkdir -p internal/features/newfeature

# 2. 创建文件
touch internal/features/newfeature/{interface,deps,service,service_test}.go

# 3. 实现接口和逻辑

# 4. 在 Facade 中注册
```

### 4.2 添加新 Core Service

```bash
# 1. 创建目录
mkdir -p internal/core/newservice

# 2. 创建文件
touch internal/core/newservice/{interface,deps,types,errors,client,client_test}.go

# 3. 实现逻辑

# 4. 在 Facade 中初始化
```

---

## 5. 测试策略

### 5.1 单元测试

每个模块使用 Mock 依赖进行独立测试：

```go
func TestImpl_GetFeed(t *testing.T) {
    // Arrange - Mock 依赖
    mockArxiv := &mockArxivService{...}
    mockRepo := newMockPaperRepository()
    svc := New(mockArxiv, mockRepo, 5*time.Minute)

    // Act
    papers, err := svc.GetFeed(ctx, req)

    // Assert
    assert.NoError(t, err)
    assert.Len(t, papers, 1)
}
```

### 5.2 运行测试

```bash
# 所有测试
go test ./...

# 特定模块
go test ./internal/features/paperfeed/...

# 带覆盖率
go test -cover ./...
```

---

## 6. 相关文档

- [01-项目架构总览.md](./01-项目架构总览.md) - 架构概览
- [04-API接口说明.md](./04-API接口说明.md) - API 文档
- [../docs/DESIGN_PRINCIPLES.md](../docs/DESIGN_PRINCIPLES.md) - 设计原则
